<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black Box Intelligence</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(6, 182, 212, 0.3); border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(6, 182, 212, 0.5); }
        
        .scan-line {
            position: fixed; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(6, 182, 212, 0.3);
            animation: scan 3s linear infinite; pointer-events: none; z-index: 50; opacity: 0.3;
        }
        @keyframes scan { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh); } }
        
        /* Mobile Optimization */
        input, textarea, button, select, a { -webkit-tap-highlight-color: transparent; }
        input[type="text"], input[type="number"], textarea { font-size: 16px; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            BrainCircuit, Shield, Anchor, Zap, Trash2, Plus, 
            ArrowRight, Activity, Database, Sparkles, Loader2,
            FileText, AlertTriangle, CheckCircle, Search, X,
            HelpCircle, BookOpen, ChevronRight, Eye, Lock, Download,
            Check, Clock, Info
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, increment } from 'firebase/firestore';

        // =================================================================================
        // â–¼â–¼â–¼ ä½¿ç”¨è€…è¨­å®šå€ â–¼â–¼â–¼
        // =================================================================================
        
        const myFirebaseConfig = {
  apiKey: "AIzaSyAgNktz8JUCOglOtB-zyle-FSfIV0TbVRc",
  authDomain: "blackbox-48253.firebaseapp.com",
  projectId: "blackbox-48253",
  storageBucket: "blackbox-48253.firebasestorage.app",
  messagingSenderId: "349317379720",
  appId: "1:349317379720:web:e006daa4643c5310ebd13d"
        };

        const GEMINI_API_KEY = ""; 

        // =================================================================================

        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : myFirebaseConfig;
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;
        const db = app ? getFirestore(app) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'black-box-standalone';

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            if (!GEMINI_API_KEY) {
                console.warn("No Gemini API Key provided. Using mock response.");
                await new Promise(r => setTimeout(r, 1500));
                return JSON.stringify({
                    rootCause: "æ ¸å¿ƒåˆ¤å®šï¼šé€™æ˜¯ä¸€å€‹ã€Œå¾…é©—è­‰çš„æ­£å‘è¨Šè™Ÿã€",
                    strategy: "æˆ°è¡“å»ºè­°ï¼šå°‡æ­¤äº‹ä»¶æ¨™è¨˜ç‚ºã€Œè§€å¯ŸæœŸã€ã€‚åœ¨æ¥ä¸‹ä¾†çš„å…©é€±å…§ï¼Œæ¯é€±äº”æª¢è¦–é€²åº¦ã€‚è‹¥ç„¡é€²å±•ï¼Œå‰‡è½‰ç‚ºã€Œç•«é¤…ã€æ¨¡å¼ä¸¦å•Ÿå‹•é˜²ç¦¦å”è­°ã€‚"
                });
            }
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { console.error(e); return null; }
        };

        // --- Mock Data ---
        const MOCK_DATA = {
            patterns: [
                { 
                    text: 'è¨Šè™Ÿï¼šè€é—†æåˆ°ç³»çµ±åšå®Œæœ‰æ–°ä»»å‹™ï¼Œæ„Ÿåˆ° Promising', 
                    count: 1, 
                    status: 'active', 
                    logs: [
                        {timestamp: new Date().toISOString(), note: 'é¦–æ¬¡åµæ¸¬ï¼šä¿æŒè§€å¯Ÿï¼Œä¸é æ”¯é–‹å¿ƒ'}
                    ] 
                },
                { 
                    text: 'æ¨¡å¼ï¼šè¢«ä»–äººæŒ‡è²¬æ™‚è…¦è¢‹ä¸€ç‰‡ç©ºç™½', 
                    count: 3, 
                    status: 'active', 
                    logs: [
                        {timestamp: new Date(Date.now() - 86400000 * 14).toISOString(), note: 'ä¸»ç®¡èªæ°£å¾ˆé‡'},
                        {timestamp: new Date(Date.now() - 86400000 * 7).toISOString(), note: 'åŒäº‹è³ªç–‘æˆ‘çš„é€²åº¦'},
                        {timestamp: new Date().toISOString(), note: 'å®¶äººç¢å¿µ'}
                    ] 
                }
            ],
            protocols: [
                { type: 'tactical', rule: 'SOPï¼šç•¶æ„Ÿåˆ°ç„¦æ…®æ™‚ -> æˆ´ä¸Šé™å™ªè€³æ©Ÿï¼Œæ’­æ”¾ä¸‹é›¨è² 10 åˆ†é˜', trigger: 'ç’°å¢ƒå™ªéŸ³éå¤§' },
                { type: 'strategic', rule: 'æˆ°ç•¥ï¼šé¢å°æƒ…ç·’å‹’ç´¢ -> åŸ·è¡Œã€Œè§€å¯Ÿè€…æ¨¡å¼ã€ï¼Œåªå›æ‡‰äº‹å¯¦ï¼Œä¸è§£é‡‹æ„Ÿå—', trigger: 'äººéš›ç•Œç·šä¾µçŠ¯', rootCause: 'è¨å¥½å‹äººæ ¼æ…£æ€§' }
            ]
        };

        const THEMES = {
            dark: {
                bg: 'bg-slate-950',
                panel: 'bg-slate-900/90',
                panelBorder: 'border-slate-800',
                textMain: 'text-slate-200',
                textDim: 'text-slate-500',
                textHighlight: 'text-white',
                inputBg: 'bg-slate-900',
                inputBorder: 'border-slate-700',
                buttonInactive: 'bg-slate-900 border-slate-700 text-slate-400',
            }
        };

        const TRANSLATIONS = {
            zh: {
                patternBtn: "é»‘ç›’å­",
                patternTitle: "é»‘ç›’å­åˆ†æå„€ (æ¨¡å¼è­˜åˆ¥)",
                patternSub: "å°‡é‡è¤‡å‡ºç¾çš„è¨Šè™Ÿè½‰åŒ–ç‚ºæ°¸ä¹…å”è­°ã€‚",
                patternInputPlaceholder: "åµæ¸¬è¨Šè™Ÿï¼šç„¦æ…®ã€æ©Ÿæœƒã€ç•«é¤…...",
                sopInputPlaceholder: "è¼¸å…¥ SOP å…§å®¹...",
                patternAdd: "è¨˜éŒ„è¨Šè™Ÿ",
                patternListTitle: "åµæ¸¬æ¨¡å¼ (é»æ“Š +1)",
                patternProtocolTitle: "å·²å»ºç«‹å”è­°",
                patternConvert: "è½‰åŒ–å”è­°",
                patternResolve: "å»ºç«‹å”è­°",
                patternDelete: "éŠ·æ¯€",
                patternCount: "æ¬¡æ•¸:",
                patternThreshold: "é”åˆ°é–¾å€¼",
                patternTypeTactical: "æˆ°è¡“ (SOP)",
                patternTypeStrategic: "æˆ°ç•¥ (çµæ§‹)",
                patternTypeQuest: "æ¢ç´¢ä»»å‹™",
                patternRootCause: "æ ¸å¿ƒè¡çª / æ ¹æœ¬åŸå› :",
                patternStrategy: "æˆ°ç•¥èª¿æ•´ (é•·æœŸæŒ‡ä»¤):",
                questPrefix: "âš”ï¸ æ¢ç´¢ä»»å‹™ï¼š",
                initialLog: "é¦–æ¬¡åµæ¸¬è¨Šè™Ÿ",
                incubatingLabel: "å­µåŒ–ä¸­",
                btnAIAnalyze: "âœ¨ AI åˆ†æ",
                analyzing: "é‹ç®—ä¸­...",
                emptySignals: "ç›®å‰ç„¡æ´»èºè¨Šè™Ÿã€‚",
                close: "é—œé–‰",
                closeCase: "çµæ¡ˆ",
                confirmLog: "ç¢ºèªè¨˜éŒ„",
                addContext: "RECURRED",
                contextPlaceholder: "é€™æ¬¡ç‚ºä»€éº¼ç™¼ç”Ÿï¼Ÿ(æƒ…å¢ƒ)",
                caseHistory: "æ¡ˆæƒ…æ­·ç¨‹ (è­‰æ“š):",
                questInfo: "é€™å°‡åœ¨ä½ çš„ä»»å‹™åˆ—è¡¨ä¸­å»ºç«‹ä¸€å€‹<strong>æ¢ç´¢ä»»å‹™</strong>ï¼Œä¸¦å°‡æ­¤æ¨¡å¼ç§»è‡³å­µåŒ–å€ã€‚ç¾åœ¨ä¸éœ€è¦æ€¥è‘—è§£æ±ºã€‚",
                btnSaveSOP: "å„²å­˜ SOP",
                btnDeployStrategy: "éƒ¨ç½²æˆ°ç•¥",
                btnCreateQuest: "å»ºç«‹æ¢ç´¢ä»»å‹™",
                labelStrategic: "æˆ°ç•¥æŒ‡ä»¤",
                labelSOP: "SOP å·²å»ºç«‹",
                labelRootCause: "æ ¹æœ¬åŸå› :",
                labelOrigin: "ä¾†æº:",
                systemDefs: {
                    blackbox: { title: "é»‘ç›’å­ (Black Box)", subtitle: "æ¨¡å¼è­˜åˆ¥ (Pattern)", keyword: "é€²åŒ– (Evolution)", desc: "é‡è¤‡ç™¼ç”Ÿçš„äº‹ (3æ¬¡ä»¥ä¸Š)ã€‚ç”¨æ–¼å„ªåŒ–æµç¨‹ã€å»ºç«‹SOPã€‚" },
                }
            }
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [patterns, setPatterns] = useState([]);
            const [protocols, setProtocols] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(true);
            const [mobileTab, setMobileTab] = useState('scanner'); 
            
            const t = TRANSLATIONS['zh'];
            const theme = THEMES['dark'];
            const isDark = true;

            const [activePattern, setActivePattern] = useState(null);
            const [activePatternId, setActivePatternId] = useState(null);
            const [showGuide, setShowGuide] = useState(false);
            const [guideTab, setGuideTab] = useState('manual'); 
            const [analysisType, setAnalysisType] = useState('tactical');
            const [sopInput, setSopInput] = useState('');
            const [rootInput, setRootInput] = useState('');
            const [strategyInput, setStrategyInput] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            
            const [actionId, setActionId] = useState(null); 
            const [actionType, setActionType] = useState(null); 
            const [actionNote, setActionNote] = useState('');

            const [isLoadingPatterns, setIsLoadingPatterns] = useState(true);

            // Auth & Init
            useEffect(() => {
                if (!auth) {
                    setPatterns(MOCK_DATA.patterns.map((p, i) => ({...p, id: `m${i}`})));
                    setProtocols(MOCK_DATA.protocols.map((p, i) => ({...p, id: `p${i}`})));
                    setLoading(false);
                    setIsLoadingPatterns(false);
                    return;
                }
                signInAnonymously(auth).catch(e => console.error(e));
                return onAuthStateChanged(auth, u => {
                    setUser(u);
                    if(!u) {
                        setLoading(false);
                        setIsLoadingPatterns(false);
                    }
                });
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!user || !db) return;
                
                const qPatterns = query(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), orderBy('count', 'desc'));
                const unsubP = onSnapshot(qPatterns, (snapshot) => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPatterns(loaded);
                    setIsLoadingPatterns(false);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching patterns:", error);
                    setIsLoadingPatterns(false);
                });

                const qProtocols = query(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), orderBy('createdAt', 'desc'));
                const unsubPro = onSnapshot(qProtocols, (snapshot) => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProtocols(loaded);
                });

                return () => { unsubP(); unsubPro(); };
            }, [user, db]);

            // --- Logic Functions ---

            const addPattern = async () => {
                if (!input.trim()) return;
                const newP = {
                    text: input, count: 1, logs: [{ timestamp: new Date().toISOString(), note: t.initialLog }], status: 'active', createdAt: serverTimestamp()
                };
                if(db && user) {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), newP);
                } else {
                    setPatterns(prev => [{...newP, id: Date.now().toString(), createdAt: new Date()}, ...prev]);
                }
                setInput('');
            };

            const loadDemoData = async () => {
                if (!db || !user) return;
                setIsLoadingPatterns(true);
                try {
                    for (const p of MOCK_DATA.patterns) {
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), { ...p, createdAt: serverTimestamp() });
                    }
                    for (const p of MOCK_DATA.protocols) {
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), { ...p, createdAt: serverTimestamp() });
                    }
                    alert("ç¯„ä¾‹è³‡æ–™å·²åŒ¯å…¥ï¼");
                } catch (e) { console.error(e); }
                setIsLoadingPatterns(false);
            };

            const handleActionClick = (id, type) => {
                if (actionId === id && actionType === type) {
                    setActionId(null); setActionType(null); setActionNote('');
                } else {
                    setActionId(id); setActionType(type); setActionNote('');
                }
            };

            const confirmAction = async (pattern) => {
                const timestamp = new Date().toISOString();
                const newLog = { timestamp, note: actionNote || "Update" };

                if (actionType === 'increment') {
                    if (db && user && !pattern.id.startsWith('m')) {
                        const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id);
                        await updateDoc(ref, { count: pattern.count + 1, logs: [...(pattern.logs||[]), newLog] });
                    } else {
                        setPatterns(prev => prev.map(p => p.id === pattern.id ? { ...p, count: p.count + 1, logs: [...(p.logs||[]), newLog] } : p));
                    }
                } else if (actionType === 'verify') {
                    const newProto = {
                        trigger: pattern.text, type: 'strategic', rootCause: "âœ… æ‰¿è«¾å…Œç¾ (VERIFIED)",
                        rule: `é©—è­‰ç´€éŒ„ï¼š${actionNote || "Promise fulfilled."}`, createdAt: serverTimestamp()
                    };
                    if(db && user && !pattern.id.startsWith('m')) {
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), newProto);
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id));
                    } else {
                        setProtocols(prev => [{...newProto, id: Date.now().toString()}, ...prev]);
                        setPatterns(prev => prev.filter(p => p.id !== pattern.id));
                    }
                }
                setActionId(null); setActionType(null); setActionNote('');
            };

            const deletePattern = async (id) => {
                if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
                if(db && user && !id.toString().startsWith('m')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', id));
                } else {
                    setPatterns(prev => prev.filter(p => p.id !== id));
                }
            };

            const deleteProtocol = async (id) => {
                if (!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
                if(db && user && !id.toString().startsWith('p')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'protocols', id));
                } else {
                    setProtocols(prev => prev.filter(p => p.id !== id));
                }
            };

            const handleAIAnalyze = async (pattern) => {
                setAiLoading(true);
                const logsText = pattern.logs.map(l => l.note).join('\n');
                const prompt = `åˆ†æè¡Œç‚ºæ¨¡å¼ï¼šã€Œ${pattern.text}ã€ã€‚ç´€éŒ„ï¼š${logsText}ã€‚è«‹å›å‚³JSONï¼š{"rootCause": "æ ¸å¿ƒåŸå› ", "strategy": "å»ºè­°ç­–ç•¥"}`;
                const res = await callGemini(prompt);
                if (res) {
                    try {
                        const json = JSON.parse(res.replace(/```json|```/g, '').trim());
                        setAnalysisType('strategic'); setRootInput(json.rootCause); setStrategyInput(json.strategy);
                    } catch(e) {
                        setAnalysisType('strategic'); setRootInput("AI åˆ†ææ ¼å¼éŒ¯èª¤"); setStrategyInput(res);
                    }
                }
                setAiLoading(false);
            };

            const convertToProtocol = async (pattern) => {
                const newProto = { trigger: pattern.text, type: analysisType, createdAt: serverTimestamp() };
                if (analysisType === 'tactical') newProto.rule = sopInput;
                else if (analysisType === 'strategic') { newProto.rootCause = rootInput; newProto.rule = strategyInput; }
                else newProto.rule = `æ¢ç´¢ä»»å‹™: ${pattern.text}`; 

                if (db && user && !pattern.id.startsWith('m')) {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), newProto);
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id));
                } else {
                    setProtocols(prev => [{...newProto, id: Date.now().toString()}, ...prev]);
                    setPatterns(prev => prev.filter(p => p.id !== pattern.id));
                }
                setActivePattern(null); setSopInput(''); setRootInput(''); setStrategyInput('');
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-cyan-500 font-mono bg-slate-950">SYSTEM INITIALIZING...</div>;
            
            // Safe userId access
            const userId = user?.uid;

            return (
                 <div className="h-[100dvh] bg-slate-950 text-slate-200 font-mono p-4 md:p-6 pb-20 relative overflow-hidden flex flex-col">
                    <div className="scan-line"></div>
                    
                    {/* Header */}
                    <header className="flex justify-between items-center mb-4 border-b border-cyan-500/30 pb-4 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-cyan-500/10 rounded border border-cyan-500/50"><BrainCircuit className="text-cyan-400" size={20} /></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-widest text-cyan-400">BLACK BOX</h1>
                                <p className="text-[10px] text-slate-500">INTELLIGENCE UNIT</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex items-center gap-1.5 text-[10px]">
                                <div className={`w-1.5 h-1.5 rounded-full ${user ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500'}`}></div>
                                <span className="text-slate-400 hidden sm:inline">{user ? 'ONLINE' : 'OFFLINE'}</span>
                            </div>
                            <button onClick={() => setShowGuide(true)} className="text-slate-400 hover:text-cyan-400 p-2 hover:bg-slate-800 rounded-full"><HelpCircle size={20} /></button>
                        </div>
                    </header>

                    {/* Mobile Tab Switcher */}
                    <div className="lg:hidden flex mb-4 bg-slate-900 rounded p-1 border border-slate-800 shrink-0">
                        <button onClick={() => setMobileTab('scanner')} className={`flex-1 py-2 text-xs font-bold rounded transition-all ${mobileTab === 'scanner' ? 'bg-cyan-500/20 text-cyan-400' : 'text-slate-500'}`}>æƒæå„€ (SCANNER)</button>
                        <button onClick={() => setMobileTab('archive')} className={`flex-1 py-2 text-xs font-bold rounded transition-all ${mobileTab === 'archive' ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500'}`}>æª”æ¡ˆåº« (ARCHIVE)</button>
                    </div>

                    {/* Input Area */}
                    <div className={`mb-6 shrink-0 ${mobileTab === 'scanner' ? 'block' : 'hidden lg:block'}`}>
                        <div className="relative group shadow-[0_0_20px_rgba(8,145,178,0.2)]">
                            <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-lg blur opacity-30 group-hover:opacity-60 transition duration-1000"></div>
                            <div className="relative flex bg-slate-900 rounded-lg p-1 border border-slate-700 items-center">
                                <input 
                                    type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addPattern()}
                                    placeholder={t.patternInputPlaceholder} 
                                    className="flex-1 bg-transparent border-none focus:ring-0 text-slate-200 px-3 py-3 placeholder:text-slate-500 text-sm md:text-base w-full"
                                />
                                <button onClick={addPattern} className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-md font-bold text-xs tracking-wider transition-colors flex items-center gap-1 shrink-0">
                                    <Activity size={14} /> <span className="hidden sm:inline">RECORD</span>
                                </button>
                            </div>
                        </div>
                         <p className={`text-[10px] mt-2 ml-1 ${theme.textDim} opacity-70 flex items-center gap-1`}><Info size={10} className="inline"/>{t.patternInputHelp}</p>
                    </div>

                    <main className="flex-1 min-h-0 flex flex-col lg:grid lg:grid-cols-2 gap-6 overflow-hidden">
                        
                        {/* Left: Active Patterns (Scanner) */}
                        <section className={`flex-1 flex-col min-h-0 ${mobileTab === 'scanner' ? 'flex' : 'hidden lg:flex'}`}>
                            <div className="flex items-center justify-between mb-2 px-1 shrink-0">
                                <h2 className="text-xs font-bold text-slate-400 flex items-center gap-2"><Activity size={14} /> ACTIVE SIGNALS</h2>
                                <span className="bg-slate-800 text-slate-400 px-2 py-0.5 rounded text-[10px]">{patterns.length}</span>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1">
                                {patterns.length === 0 && !isLoadingPatterns && (
                                    <div className="text-center py-10 text-slate-600 text-xs border border-dashed border-slate-800 rounded-lg flex flex-col items-center gap-3">
                                        <span>{t.emptySignals}</span>
                                        {user && db && <button onClick={loadDemoData} className="flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded transition-colors text-xs border border-slate-600"><Download size={12} /> å¯«å…¥ç¯„ä¾‹è³‡æ–™</button>}
                                    </div>
                                )}
                                {patterns.map(p => (
                                    <div key={p.id} className={`bg-slate-900/80 border ${p.count >= 3 ? 'border-rose-500/50 shadow-[0_0_15px_rgba(244,63,94,0.1)]' : 'border-slate-800'} rounded-lg p-4 transition-all`}>
                                        <div className="flex justify-between items-start gap-4">
                                            <div className="flex-1 min-w-0">
                                                <h3 className={`font-bold text-sm md:text-base leading-relaxed break-words ${p.count >= 3 ? 'text-rose-400' : 'text-slate-200'}`}>{p.text}</h3>
                                                <div className="text-[10px] text-slate-500 mt-1.5 flex items-center gap-2">
                                                    <Clock size={10} /> {new Date(p.createdAt?.toDate ? p.createdAt.toDate() : p.createdAt || Date.now()).toLocaleDateString()}
                                                </div>
                                            </div>
                                            <button onClick={() => deletePattern(p.id)} className="text-slate-600 hover:text-rose-500 transition-colors p-1"><Trash2 size={16} /></button>
                                        </div>

                                        <div className="mt-4 flex items-center justify-between bg-slate-950/50 p-2 rounded border border-slate-800/50">
                                            <div className="flex items-center gap-2">
                                                <span className={`text-[10px] uppercase text-slate-500 tracking-wider`}>COUNT</span>
                                                <span className={`text-lg font-mono font-black ${p.count >= 3 ? 'text-rose-500' : 'text-cyan-500'}`}>{p.count}</span>
                                            </div>
                                            
                                            {p.count >= 3 ? (
                                                <button onClick={() => setActivePattern(p)} className="bg-rose-500/10 border border-rose-500/50 text-rose-500 px-3 py-1.5 rounded text-xs font-bold hover:bg-rose-500 hover:text-white transition-all flex items-center gap-1 animate-pulse">
                                                    <AlertTriangle size={12} /> ANALYZE
                                                </button>
                                            ) : (
                                                <div className="flex gap-2">
                                                    <button onClick={() => handleActionClick(p.id, 'verify')} className={`text-[10px] font-bold border border-emerald-500/30 text-emerald-500 px-2 py-1 rounded hover:bg-emerald-500/20 transition-colors ${theme.buttonInactive}`}><Check size={12} className="inline mr-1"/> REALIZED</button>
                                                    <button onClick={() => handleActionClick(p.id, 'increment')} className={`text-[10px] font-bold border px-2 py-1 rounded hover:bg-cyan-500/20 hover:text-cyan-500 transition-colors ${theme.buttonInactive}`}>{t.addContext}</button>
                                                </div>
                                            )}
                                        </div>

                                        {actionId === p.id && (
                                            <div className={`mt-2 pt-2 border-t ${actionType === 'verify' ? 'border-emerald-500/30' : 'border-slate-700/50'} animate-in fade-in`}>
                                                <p className={`text-[10px] mb-1 font-bold ${actionType === 'verify' ? 'text-emerald-400' : 'text-cyan-400'}`}>
                                                    {actionType === 'verify' ? "âœ… ç¢ºèªè¨Šè™Ÿå·²å…Œç¾ (Verify):" : "ğŸ“ å†æ¬¡ç™¼ç”Ÿç´€éŒ„ (Log Recurrence):"}
                                                </p>
                                                <input autoFocus type="text" value={actionNote} onChange={(e) => setActionNote(e.target.value)} placeholder={actionType === 'verify' ? "çµæœå¦‚ä½•ï¼Ÿ" : t.contextPlaceholder} className={`w-full ${theme.inputBg} ${actionType === 'verify' ? 'border-emerald-500/30' : 'border-cyan-500/30'} border rounded px-2 py-1 text-xs mb-1 focus:outline-none`} onKeyDown={(e) => e.key === 'Enter' && confirmAction(p)} />
                                                <button onClick={() => confirmAction(p)} className={`w-full text-[10px] py-1 rounded ${actionType === 'verify' ? 'bg-emerald-500/20 text-emerald-500' : 'bg-cyan-500/10 text-cyan-500'}`}>{t.confirmLog}</button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Right: Protocols (Archive) */}
                        <section className={`flex-1 flex-col min-h-0 ${mobileTab === 'archive' ? 'flex' : 'hidden lg:flex'}`}>
                            <div className="flex items-center justify-between mb-2 px-1 shrink-0">
                                <h2 className="text-xs font-bold text-slate-400 flex items-center gap-2"><Database size={14} /> PROTOCOLS</h2>
                            </div>

                            <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1">
                                {protocols.map(proto => (
                                    <div key={proto.id} className={`bg-slate-900 border ${proto.type === 'strategic' ? 'border-amber-500/30' : 'border-emerald-500/30'} rounded-lg p-4 relative group`}>
                                        <div className="flex items-center gap-2 mb-1">
                                            {proto.type === 'strategic' ? <Anchor size={14} className="text-amber-500" /> : <Shield size={14} className="text-emerald-500" />}
                                            <span className={`text-[10px] font-bold uppercase ${proto.type === 'strategic' ? 'text-amber-500' : 'text-emerald-500'}`}>
                                                {proto.type === 'strategic' ? t.labelStrategic : t.labelSOP}
                                            </span>
                                        </div>
                                        {proto.type === 'strategic' && proto.rootCause && (
                                            <div className="text-[10px] text-amber-300/70 mb-1 font-mono">
                                                {t.labelRootCause} {proto.rootCause}
                                            </div>
                                        )}
                                        <div className={`text-sm font-bold ${theme.textMain} mb-2 leading-relaxed`}>{proto.rule}</div>
                                        <div className={`text-[10px] ${theme.textDim} border-t ${theme.panelBorder} pt-2 mt-2 flex justify-between items-center`}>
                                            <span className="truncate max-w-[200px]">{t.labelOrigin} "{proto.trigger}"</span>
                                            <button onClick={() => deleteProtocol(proto.id)} className="text-slate-600 hover:text-rose-500 p-1"><Trash2 size={12}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>

                    {/* Modals (Guide & Analysis) */}
                    {showGuide && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-3xl shadow-2xl overflow-hidden relative flex flex-col max-h-[85vh]">
                                <div className="p-4 md:p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950 shrink-0">
                                    <div className="flex items-center gap-3">
                                        <BookOpen className="text-cyan-400" size={20} />
                                        <h2 className="text-lg font-bold text-white">SYSTEM MANUAL</h2>
                                    </div>
                                    <button onClick={() => setShowGuide(false)} className="text-slate-500 hover:text-white p-1"><X size={24} /></button>
                                </div>

                                <div className="flex border-b border-slate-800 bg-slate-950/50 shrink-0">
                                    <button onClick={() => setGuideTab('manual')} className={`flex-1 py-3 text-xs md:text-sm font-bold tracking-wide transition-colors ${guideTab === 'manual' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-500/5' : 'text-slate-500 hover:text-slate-300'}`}>æ“ä½œæ‰‹å†Š</button>
                                    <button onClick={() => setGuideTab('intel')} className={`flex-1 py-3 text-xs md:text-sm font-bold tracking-wide transition-colors ${guideTab === 'intel' ? 'text-amber-400 border-b-2 border-amber-400 bg-amber-500/5' : 'text-slate-500 hover:text-slate-300'}`}>è¨Šè™Ÿæƒ…å ±åˆ¤è®€</button>
                                </div>
                                
                                <div className="p-6 md:p-8 overflow-y-auto custom-scrollbar flex-1">
                                    {guideTab === 'manual' ? (
                                        <div className="space-y-6">
                                            {[{step: 1, title: "CAPTURE (æ•æ‰)", desc: "åµæ¸¬ä»»ä½•å¼•èµ·æƒ…ç·’æ³¢å‹•çš„è¨Šè™Ÿï¼ˆç„¦æ…®ã€èˆˆå¥®ã€ç•«é¤…æ„Ÿï¼‰ã€‚å…ˆæ•æ‰ï¼Œä¸è©•åˆ¤ã€‚", color: "text-cyan-400"}, {step: 2, title: "VERIFY / RECUR (é©—è­‰/è­˜åˆ¥)", desc: "è‹¥è¨Šè™ŸæˆçœŸäº†ï¼Œé»æ“Šã€Œâœ… REALIZEDã€è½‰åŒ–ç‚ºè³‡ç”¢ã€‚è‹¥è¨Šè™Ÿè½ç©ºæˆ–é‡è¤‡ç™¼ç”Ÿï¼Œé»æ“Šã€ŒRECURREDã€ç´¯è¨ˆæ¬¡æ•¸ã€‚", color: "text-cyan-400"}, {step: 3, title: "ANALYZE (åˆ†æ)", desc: "ç•¶è² é¢è¨Šè™Ÿç´¯ç© 3 æ¬¡ï¼ŒANALYZE ç‡ˆè™Ÿäº®èµ·ã€‚é€²å…¥åˆ†æå®¤æ‰¾å‡ºæ ¸å¿ƒè¡çªã€‚", color: "text-rose-400"}, {step: 4, title: "PROTOCOL (å”è­°)", desc: "åˆ¶å®š SOP æˆ–æˆ°ç•¥ã€‚éŠ·æ¯€æ¨¡å¼ï¼Œè½‰åŒ–ç‚ºæ°¸ä¹…ç”Ÿæ•ˆçš„å”è­°ã€‚", color: "text-emerald-400"}].map((item, i) => (
                                                <div key={i} className="flex gap-4"><div className="flex-none w-8 h-8 rounded-full bg-slate-800 text-slate-300 flex items-center justify-center font-bold border border-slate-700 text-sm">{item.step}</div><div><h3 className={`text-sm font-bold ${item.color} mb-1`}>{item.title}</h3><p className="text-xs text-slate-400 leading-relaxed">{item.desc}</p></div></div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="space-y-6 text-sm text-slate-300 leading-relaxed">
                                            <div className="p-4 bg-amber-500/5 border border-amber-500/20 rounded-lg"><h3 className="text-amber-400 font-bold mb-2 flex items-center gap-2"><Eye size={16}/> æˆ°è¡“æ ¸å¿ƒï¼šæ­£å‘è¨Šè™Ÿ</h3><p className="italic text-slate-400 text-xs">ã€Œè€é—†èªªé‚„æœ‰å…¶ä»–äº‹è¦æˆ‘åšï¼Œè¦ºå¾—å¾ˆ Promisingã€‚é€™ç¨®è¨Šè™Ÿéœ€è¦æ•æ‰å—ï¼Ÿã€</p></div>
                                            <p className="text-xs text-emerald-400 font-bold">çµè«–ï¼šå¿…é ˆæ•æ‰ã€‚é€™å±¬æ–¼ã€Œå¾…é©—è­‰è¨Šè™Ÿã€ã€‚æˆ‘å€‘è¨˜éŒ„æ˜¯ç‚ºäº†é©—è­‰é€™å®¶å…¬å¸çš„é‹ä½œè¦å¾‹ã€‚</p>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                                <div className="p-3 bg-emerald-500/5 border border-emerald-500/20 rounded"><h5 className="text-emerald-400 font-bold text-xs mb-2">æƒ…å¢ƒ Aï¼šè‰¯æ€§å¾ªç’°</h5><ul className="text-xs space-y-1 text-slate-400 list-disc pl-4"><li>è¨Šè™Ÿï¼šè€é—†èªªæœ‰æ–°æ¡ˆå­ -> çµæœï¼šçœŸçš„è®“ä½ æ¥æ‰‹ã€‚</li><li className="mt-2 text-white">è¡Œå‹•ï¼šé»æ“Š <span className="text-emerald-400 font-bold">âœ… REALIZED</span></li></ul></div>
                                                <div className="p-3 bg-rose-500/5 border border-rose-500/20 rounded"><h5 className="text-rose-400 font-bold text-xs mb-2">æƒ…å¢ƒ Bï¼šç•«é¤…å¾ªç’°</h5><ul className="text-xs space-y-1 text-slate-400 list-disc pl-4"><li>è¨Šè™Ÿï¼šè€é—†èªªæœ‰æ–°æ¡ˆå­ -> çµæœï¼šç„¡è²ç„¡æ¯ã€‚</li><li className="mt-2 text-white">è¡Œå‹•ï¼šé»æ“Š <span className="text-cyan-400 font-bold">RECURRED</span></li></ul></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-950 text-center shrink-0">
                                    <button onClick={() => setShowGuide(false)} className="bg-cyan-600 hover:bg-cyan-500 text-white w-full py-3 rounded font-bold text-sm transition-colors">ACKNOWLEDGED</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {activePattern && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950 shrink-0">
                                    <h3 className="text-base font-bold text-rose-400 flex items-center gap-2"><AlertTriangle size={18} /> ANALYSIS</h3>
                                    <button onClick={() => setActivePattern(null)} className="text-slate-500 hover:text-white"><X size={24} /></button>
                                </div>
                                <div className="p-4 space-y-6 overflow-y-auto custom-scrollbar flex-1">
                                    <div className="bg-slate-900 p-4 rounded border border-slate-800">
                                        <div className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Subject</div>
                                        <div className="text-base font-bold text-white">{activePattern.text}</div>
                                        <div className="mt-3 text-[10px] text-slate-500 border-t border-slate-800 pt-2"><span className="block mb-1">LOGS:</span>{activePattern.logs?.map((l, i) => (<div key={i} className="pl-2 border-l border-slate-700 mb-1">{l.note} <span className="opacity-50">({l.timestamp.split('T')[0]})</span></div>))}</div>
                                    </div>
                                    <button onClick={() => handleAIAnalyze(activePattern)} disabled={aiLoading} className="w-full py-3 bg-gradient-to-r from-violet-600 to-indigo-600 rounded text-xs font-bold text-white flex items-center justify-center gap-2 hover:shadow-lg transition-all">{aiLoading ? <Loader2 className="animate-spin" size={14}/> : <Sparkles size={14}/>} {aiLoading ? 'ANALYZING...' : 'AI ASSIST: IDENTIFY ROOT CAUSE'}</button>
                                    <div className="flex p-1 bg-slate-950 rounded-lg">
                                        {['tactical', 'strategic', 'quest'].map(type => (
                                            <button key={type} onClick={() => setAnalysisType(type)} className={`flex-1 py-2 text-[10px] font-bold uppercase rounded-md transition-all ${analysisType === type ? 'bg-slate-800 text-cyan-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}>{type}</button>
                                        ))}
                                    </div>
                                    <div className="space-y-4">
                                        {analysisType === 'tactical' && (<div><label className="text-xs font-bold text-emerald-500 mb-2 block">SOP / ACTION RULE</label><input type="text" value={sopInput} onChange={e => setSopInput(e.target.value)} placeholder="ç•¶ X ç™¼ç”Ÿæ™‚ï¼ŒåŸ·è¡Œ Y..." className="w-full bg-slate-950 border border-emerald-500/30 rounded p-3 text-sm focus:border-emerald-500 outline-none"/></div>)}
                                        {analysisType === 'strategic' && (<><div><label className="text-xs font-bold text-amber-500 mb-2 block">ROOT CAUSE</label><input type="text" value={rootInput} onChange={e => setRootInput(e.target.value)} className="w-full bg-slate-950 border border-amber-500/30 rounded p-3 text-sm focus:border-amber-500 outline-none mb-3"/></div><div><label className="text-xs font-bold text-amber-500 mb-2 block">STRATEGY</label><textarea value={strategyInput} onChange={e => setStrategyInput(e.target.value)} className="w-full bg-slate-950 border border-amber-500/30 rounded p-3 text-sm focus:border-amber-500 outline-none h-24"/></div></>)}
                                        {analysisType === 'quest' && (<div className="p-4 bg-indigo-500/10 border border-indigo-500/30 rounded text-indigo-300 text-sm"><p>é€™å°‡å»ºç«‹ä¸€å€‹<strong>æ¢ç´¢ä»»å‹™</strong>ã€‚</p></div>)}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-950 flex justify-end gap-3 shrink-0">
                                    <button onClick={() => setActivePattern(null)} className="px-4 py-2 text-slate-400 text-sm hover:text-white">Cancel</button>
                                    <button onClick={() => convertToProtocol(activePattern)} className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm tracking-wide">EXECUTE</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>