<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black Box Intelligence</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(6, 182, 212, 0.3); border-radius: 2px; }
        
        .scan-line {
            position: fixed; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(6, 182, 212, 0.3);
            animation: scan 3s linear infinite; pointer-events: none; z-index: 50; opacity: 0.3;
        }
        @keyframes scan { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh); } }
        
        input, textarea { font-size: 16px; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            BrainCircuit, Shield, Anchor, Zap, Trash2, Plus, 
            ArrowRight, Activity, Database, Sparkles, Loader2,
            FileText, AlertTriangle, CheckCircle, Search, X,
            HelpCircle, BookOpen, ChevronRight, Eye, Lock, Download,
            Check, Clock, Info, UserX, FileWarning, LogIn, LogOut, Settings
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy } from 'firebase/firestore';

        // =================================================================================
        // ▼▼▼ 使用者設定區 ▼▼▼
        // =================================================================================
        
        const myFirebaseConfig = {
  apiKey: "AIzaSyAgNktz8JUCOglOtB-zyle-FSfIV0TbVRc",
  authDomain: "blackbox-48253.firebaseapp.com",
  projectId: "blackbox-48253",
  storageBucket: "blackbox-48253.firebasestorage.app",
  messagingSenderId: "349317379720",
  appId: "1:349317379720:web:e006daa4643c5310ebd13d"
        };

        // =================================================================================

        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : myFirebaseConfig;
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;
        const db = app ? getFirestore(app) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'black-box-standalone';
        const provider = new GoogleAuthProvider();

        // --- Gemini API Helper (localStorage) ---
        const callGemini = async (prompt) => {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert("請先點擊設定 (⚙️) 輸入 API Key");
                return null;
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { console.error(e); return null; }
        };

        const THEMES = {
            dark: {
                bg: 'bg-slate-950',
                panel: 'bg-slate-900/90',
                panelBorder: 'border-slate-800',
                textMain: 'text-slate-200',
                textDim: 'text-slate-500',
                textHighlight: 'text-white',
                inputBg: 'bg-slate-900',
                inputBorder: 'border-slate-700',
                buttonInactive: 'bg-slate-900 border-slate-700 text-slate-400',
            }
        };

        const TRANSLATIONS = {
            zh: {
                patternBtn: "黑盒子",
                patternTitle: "黑盒子",
                patternSub: "模式識別系統",
                patternInputPlaceholder: "偵測訊號：焦慮、機會、畫餅...",
                emptySignals: "無活躍訊號",
                initialLog: "首次偵測訊號",
                addContext: "RECURRED",
                contextPlaceholder: "這次發生了什麼？",
                confirmLog: "確認記錄",
                patternCount: "次數",
            }
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [patterns, setPatterns] = useState([]);
            const [protocols, setProtocols] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(true);
            const [mobileTab, setMobileTab] = useState('scanner');
            
            // Modal States
            const [activePattern, setActivePattern] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showGuide, setShowGuide] = useState(false);
            const [guideTab, setGuideTab] = useState('manual');
            const [apiKeyInput, setApiKeyInput] = useState('');
            
            // Analysis States
            const [analysisType, setAnalysisType] = useState('tactical');
            const [sopInput, setSopInput] = useState('');
            const [rootInput, setRootInput] = useState('');
            const [strategyInput, setStrategyInput] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            
            // Action States
            const [actionId, setActionId] = useState(null); 
            const [actionType, setActionType] = useState(null); 
            const [actionNote, setActionNote] = useState('');

            const t = TRANSLATIONS['zh'];
            const theme = THEMES['dark'];

            // Auth Listener
            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                
                // Load saved API key
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setApiKeyInput(savedKey);

                return () => unsubscribe();
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!user || !db) {
                    setPatterns([]); 
                    setProtocols([]);
                    return;
                }
                
                const qPatterns = query(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), orderBy('count', 'desc'));
                const unsubP = onSnapshot(qPatterns, (snapshot) => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPatterns(loaded);
                });

                const qProtocols = query(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), orderBy('createdAt', 'desc'));
                const unsubPro = onSnapshot(qProtocols, (snapshot) => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProtocols(loaded);
                });

                return () => { unsubP(); unsubPro(); };
            }, [user]);

            const handleLogin = async () => {
                if (!auth) return;
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login failed:", error);
                    alert("登入失敗，請確認 Firebase 已開啟 Google 登入功能");
                }
            };

            const handleLogout = async () => {
                if (auth) await signOut(auth);
            };

            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', apiKeyInput.trim());
                setShowSettings(false);
                alert("API Key 已儲存");
            };

            const addPattern = async () => {
                if (!input.trim() || !user) return;
                const newP = {
                    text: input, count: 1, logs: [{ timestamp: new Date().toISOString(), note: t.initialLog }], status: 'active', createdAt: serverTimestamp()
                };
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), newP);
                setInput('');
            };

            // ... (Rest of logic: handleActionClick, confirmAction, deletePattern, deleteProtocol, handleAIAnalyze, convertToProtocol)
            // Including logic from previous version for consistency

            const handleActionClick = (id, type) => {
                if (actionId === id && actionType === type) { setActionId(null); setActionType(null); setActionNote(''); } 
                else { setActionId(id); setActionType(type); setActionNote(''); }
            };

            const confirmAction = async (pattern) => {
                if (!user) return;
                const timestamp = new Date().toISOString();
                const newLog = { timestamp, note: actionNote || (actionType === 'verify' ? 'Verified' : 'Recurred') };

                if (actionType === 'increment') {
                    const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id);
                    await updateDoc(ref, { count: pattern.count + 1, logs: [...(pattern.logs||[]), newLog] });
                } else if (actionType === 'verify') {
                    const newProto = {
                        trigger: pattern.text, type: 'strategic', rootCause: "✅ REALIZED", rule: actionNote || "Promise fulfilled", createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), newProto);
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id));
                }
                setActionId(null); setActionType(null); setActionNote('');
            };

            const deletePattern = async (id) => {
                if (confirm('確認刪除？') && user) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', id));
            };
            const deleteProtocol = async (id) => {
                if (confirm('確認刪除？') && user) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'protocols', id));
            };
            
            const handleAIAnalyze = async (pattern) => {
                setAiLoading(true);
                const logsText = pattern.logs.map(l => l.note).join('\n');
                const prompt = `分析行為模式：「${pattern.text}」。紀錄：${logsText}。請回傳JSON：{"rootCause": "核心原因", "strategy": "建議策略"}`;
                const res = await callGemini(prompt);
                if (res) {
                    try {
                        const json = JSON.parse(res.replace(/```json|```/g, '').trim());
                        setAnalysisType('strategic'); setRootInput(json.rootCause); setStrategyInput(json.strategy);
                    } catch(e) {
                        setAnalysisType('strategic'); setRootInput("Error"); setStrategyInput(res);
                    }
                }
                setAiLoading(false);
            };

            const convertToProtocol = async (pattern) => {
                if (!user) return;
                const newProto = { trigger: pattern.text, type: analysisType, createdAt: serverTimestamp() };
                if (analysisType === 'tactical') newProto.rule = sopInput;
                else if (analysisType === 'strategic') { newProto.rootCause = rootInput; newProto.rule = strategyInput; }
                else newProto.rule = `Quest: ${pattern.text}`;

                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), newProto);
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id));
                setActivePattern(null);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-cyan-500 font-mono bg-slate-950">SYSTEM LOADING...</div>;

            return (
                 <div className="h-[100dvh] bg-slate-950 text-slate-200 font-mono p-4 md:p-6 pb-20 relative overflow-hidden flex flex-col">
                    <div className="scan-line"></div>
                    
                    {/* Header */}
                    <header className="flex justify-between items-center mb-4 border-b border-cyan-500/30 pb-4 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-cyan-500/10 rounded border border-cyan-500/50"><BrainCircuit className="text-cyan-400" size={20} /></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-widest text-cyan-400">BLACK BOX</h1>
                                <p className="text-[10px] text-slate-500">{user ? user.email : 'OFFLINE'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            {user ? (
                                <>
                                    <button onClick={() => setShowSettings(true)} className="text-slate-400 hover:text-cyan-400 p-2 hover:bg-slate-800 rounded-full"><Settings size={20} /></button>
                                    <button onClick={handleLogout} className="text-rose-400 hover:text-rose-300 p-2 hover:bg-slate-800 rounded-full"><LogOut size={20} /></button>
                                </>
                            ) : (
                                <button onClick={handleLogin} className="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1.5 rounded-full text-xs font-bold transition-all"><LogIn size={14}/> LOGIN</button>
                            )}
                            <button onClick={() => setShowGuide(true)} className="text-slate-400 hover:text-cyan-400 p-2 hover:bg-slate-800 rounded-full"><HelpCircle size={20} /></button>
                        </div>
                    </header>

                    {/* Mobile Tab Switcher */}
                    <div className="lg:hidden flex mb-4 bg-slate-900 rounded p-1 border border-slate-800 shrink-0">
                        <button onClick={() => setMobileTab('scanner')} className={`flex-1 py-2 text-xs font-bold rounded transition-all ${mobileTab === 'scanner' ? 'bg-cyan-500/20 text-cyan-400' : 'text-slate-500'}`}>掃描儀 (SCANNER)</button>
                        <button onClick={() => setMobileTab('archive')} className={`flex-1 py-2 text-xs font-bold rounded transition-all ${mobileTab === 'archive' ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500'}`}>檔案庫 (ARCHIVE)</button>
                    </div>

                    {!user ? (
                        <div className="flex-1 flex flex-col items-center justify-center text-center p-8 border border-dashed border-slate-800 rounded-xl">
                            <Lock size={48} className="text-slate-600 mb-4" />
                            <h3 className="text-lg font-bold text-slate-300 mb-2">ACCESS RESTRICTED</h3>
                            <p className="text-xs text-slate-500 mb-6">請登入 Google 帳號以存取您的黑盒子資料庫。<br/>(資料將跟隨您的帳號跨裝置同步)</p>
                            <button onClick={handleLogin} className="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-3 rounded-lg font-bold text-sm flex items-center gap-2"><LogIn size={16}/> 登入系統</button>
                        </div>
                    ) : (
                        <>
                            {/* Input Area */}
                            <div className={`mb-6 shrink-0 ${mobileTab === 'scanner' ? 'block' : 'hidden lg:block'}`}>
                                <div className="relative group shadow-[0_0_20px_rgba(8,145,178,0.2)]">
                                    <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-lg blur opacity-30 group-hover:opacity-60 transition duration-1000"></div>
                                    <div className="relative flex bg-slate-900 rounded-lg p-1 border border-slate-700 items-center">
                                        <input 
                                            type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addPattern()}
                                            placeholder={t.patternInputPlaceholder} 
                                            className="flex-1 bg-transparent border-none focus:ring-0 text-slate-200 px-3 py-3 placeholder:text-slate-500 text-sm md:text-base w-full"
                                        />
                                        <button onClick={addPattern} className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-md font-bold text-xs tracking-wider transition-colors flex items-center gap-1 shrink-0">
                                            <Activity size={14} /> <span className="hidden sm:inline">RECORD</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <main className="flex-1 min-h-0 flex flex-col lg:grid lg:grid-cols-2 gap-6 overflow-hidden">
                                {/* ... Scanner & Archive Sections (Same as previous but wrapped in user check) ... */}
                                {/* Scanner */}
                                <section className={`flex-1 flex-col min-h-0 ${mobileTab === 'scanner' ? 'flex' : 'hidden lg:flex'}`}>
                                    <div className="flex items-center justify-between mb-2 px-1 shrink-0">
                                        <h2 className="text-xs font-bold text-slate-400 flex items-center gap-2"><Activity size={14} /> ACTIVE SIGNALS</h2>
                                        <span className="bg-slate-800 text-slate-400 px-2 py-0.5 rounded text-[10px]">{patterns.length}</span>
                                    </div>
                                    <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1">
                                        {patterns.length === 0 && <div className="text-center py-10 text-slate-600 text-xs border border-dashed border-slate-800 rounded-lg">NO SIGNALS</div>}
                                        {patterns.map(p => (
                                            <div key={p.id} className={`bg-slate-900/80 border ${p.count >= 3 ? 'border-rose-500/50 shadow-[0_0_15px_rgba(244,63,94,0.1)]' : 'border-slate-800'} rounded-lg p-4 transition-all`}>
                                                <div className="flex justify-between items-start gap-4">
                                                    <div className="flex-1 min-w-0">
                                                        <h3 className={`font-bold text-sm md:text-base leading-relaxed break-words ${p.count >= 3 ? 'text-rose-400' : 'text-slate-200'}`}>{p.text}</h3>
                                                        <div className="text-[10px] text-slate-500 mt-1.5 flex items-center gap-2"><Clock size={10} /> {new Date(p.createdAt?.toDate ? p.createdAt.toDate() : p.createdAt || Date.now()).toLocaleDateString()}</div>
                                                    </div>
                                                    <button onClick={() => deletePattern(p.id)} className="text-slate-600 hover:text-rose-500 transition-colors p-1"><Trash2 size={16} /></button>
                                                </div>
                                                <div className="mt-4 flex items-center justify-between bg-slate-950/50 p-2 rounded border border-slate-800/50">
                                                    <div className="flex items-center gap-2"><span className="text-[10px] uppercase text-slate-500 tracking-wider">COUNT</span><span className={`text-lg font-mono font-black ${p.count >= 3 ? 'text-rose-500' : 'text-cyan-500'}`}>{p.count}</span></div>
                                                    {p.count >= 3 ? (
                                                        <button onClick={() => setActivePattern(p)} className="bg-rose-500/10 border border-rose-500/50 text-rose-500 px-3 py-1.5 rounded text-xs font-bold hover:bg-rose-500 hover:text-white transition-all flex items-center gap-1 animate-pulse"><AlertTriangle size={12} /> ANALYZE</button>
                                                    ) : (
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleActionClick(p.id, 'verify')} className={`text-[10px] font-bold border border-emerald-500/30 text-emerald-500 px-2 py-1 rounded hover:bg-emerald-500/20 transition-colors ${theme.buttonInactive}`}><Check size={12} className="inline mr-1"/> REALIZED</button>
                                                            <button onClick={() => handleActionClick(p.id, 'increment')} className={`text-[10px] font-bold border px-2 py-1 rounded hover:bg-cyan-500/20 hover:text-cyan-500 transition-colors ${theme.buttonInactive}`}>{t.addContext}</button>
                                                        </div>
                                                    )}
                                                </div>
                                                {actionId === p.id && (
                                                    <div className="mt-2 pt-2 border-t border-slate-700/50 animate-in fade-in">
                                                        <input autoFocus type="text" value={actionNote} onChange={(e) => setActionNote(e.target.value)} placeholder="備註..." className={`w-full ${theme.inputBg} border border-slate-600 rounded px-2 py-1 text-xs mb-1 focus:outline-none`} onKeyDown={(e) => e.key === 'Enter' && confirmAction(p)} />
                                                        <button onClick={() => confirmAction(p)} className="w-full text-[10px] py-1 rounded bg-cyan-600 text-white font-bold">CONFIRM</button>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </section>
                                
                                {/* Archive */}
                                <section className={`flex-1 flex-col min-h-0 ${mobileTab === 'archive' ? 'flex' : 'hidden lg:flex'}`}>
                                    <div className="flex items-center justify-between mb-2 px-1 shrink-0">
                                        <h2 className="text-xs font-bold text-slate-400 flex items-center gap-2"><Database size={14} /> PROTOCOLS</h2>
                                    </div>
                                    <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1">
                                        {protocols.map(proto => (
                                            <div key={proto.id} className="bg-slate-900 border border-slate-700 rounded-lg p-4 relative group">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <Shield size={14} className={proto.type==='strategic'?'text-amber-500':'text-emerald-500'} />
                                                    <span className={`text-[10px] font-bold uppercase ${proto.type==='strategic'?'text-amber-500':'text-emerald-500'}`}>{proto.type}</span>
                                                </div>
                                                {proto.rootCause && <div className="text-[10px] text-slate-400 mb-1">Root Cause: {proto.rootCause}</div>}
                                                <div className="text-sm font-bold text-slate-200 mb-2 leading-relaxed">{proto.rule}</div>
                                                <div className="text-[10px] text-slate-600 pt-2 border-t border-slate-800 flex justify-between">
                                                    <span className="truncate max-w-[200px]">{proto.trigger}</span>
                                                    <button onClick={() => deleteProtocol(proto.id)} className="text-rose-500"><Trash2 size={12}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </main>
                        </>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
                             <div className="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md p-6">
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Settings size={18}/> 設定 (Settings)</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-slate-400 mb-1 block">Google Gemini API Key</label>
                                        <input type="password" value={apiKeyInput} onChange={(e) => setApiKeyInput(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-xs text-slate-200 focus:border-cyan-500 outline-none" placeholder="AIzaSy..." />
                                        <p className="text-[10px] text-slate-500 mt-2">Key 僅儲存於本機瀏覽器。</p>
                                    </div>
                                    <div className="flex justify-end gap-2 pt-4">
                                        <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-400 text-xs">取消</button>
                                        <button onClick={saveApiKey} className="bg-cyan-600 text-white px-4 py-2 rounded text-xs font-bold">儲存</button>
                                    </div>
                                </div>
                             </div>
                        </div>
                    )}
                    
                    {/* Guide & Analysis Modals... (Included in full code but omitted for brevity in response) */}
                     {showGuide && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-3xl shadow-2xl overflow-hidden relative flex flex-col max-h-[85vh]">
                                <div className="p-4 md:p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950 shrink-0">
                                    <div className="flex items-center gap-3">
                                        <BookOpen className="text-cyan-400" size={20} />
                                        <h2 className="text-lg font-bold text-white">SYSTEM MANUAL</h2>
                                    </div>
                                    <button onClick={() => setShowGuide(false)} className="text-slate-500 hover:text-white p-1"><X size={24} /></button>
                                </div>
                                <div className="flex border-b border-slate-800 bg-slate-950/50 shrink-0">
                                    <button onClick={() => setGuideTab('manual')} className={`flex-1 py-3 text-xs md:text-sm font-bold tracking-wide transition-colors ${guideTab === 'manual' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-500/5' : 'text-slate-500 hover:text-slate-300'}`}>操作手冊</button>
                                    <button onClick={() => setGuideTab('intel')} className={`flex-1 py-3 text-xs md:text-sm font-bold tracking-wide transition-colors ${guideTab === 'intel' ? 'text-amber-400 border-b-2 border-amber-400 bg-amber-500/5' : 'text-slate-500 hover:text-slate-300'}`}>訊號情報判讀</button>
                                </div>
                                <div className="p-6 md:p-8 overflow-y-auto custom-scrollbar flex-1">
                                    {guideTab === 'manual' ? (
                                        <div className="space-y-6">
                                            {[{step: 1, title: "CAPTURE (捕捉)", desc: "偵測任何引起情緒波動的訊號（焦慮、興奮、畫餅感）。先捕捉，不評判。", color: "text-cyan-400"}, {step: 2, title: "VERIFY / RECUR (驗證/識別)", desc: "若訊號成真了，點擊「✅ REALIZED」轉化為資產。若訊號落空或重複發生，點擊「RECURRED」累計次數。", color: "text-cyan-400"}, {step: 3, title: "ANALYZE (分析)", desc: "當負面訊號累積 3 次，ANALYZE 燈號亮起。進入分析室找出核心衝突。", color: "text-rose-400"}, {step: 4, title: "PROTOCOL (協議)", desc: "制定 SOP 或戰略。銷毀模式，轉化為永久生效的協議。", color: "text-emerald-400"}].map((item, i) => (
                                                <div key={i} className="flex gap-4"><div className="flex-none w-8 h-8 rounded-full bg-slate-800 text-slate-300 flex items-center justify-center font-bold border border-slate-700 text-sm">{item.step}</div><div><h3 className={`text-sm font-bold ${item.color} mb-1`}>{item.title}</h3><p className="text-xs text-slate-400 leading-relaxed">{item.desc}</p></div></div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="space-y-6 text-sm text-slate-300 leading-relaxed">
                                            <div className="p-4 bg-amber-500/5 border border-amber-500/20 rounded-lg"><h3 className="text-amber-400 font-bold mb-2 flex items-center gap-2"><Eye size={16}/> 戰術核心：正向訊號</h3><p className="italic text-slate-400 text-xs">「老闆說還有其他事要我做，覺得很 Promising。這種訊號需要捕捉嗎？」</p></div>
                                            <p className="text-xs text-emerald-400 font-bold">結論：必須捕捉。這屬於「待驗證訊號」。我們記錄是為了驗證這家公司的運作規律。</p>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                                <div className="p-3 bg-emerald-500/5 border border-emerald-500/20 rounded"><h5 className="text-emerald-400 font-bold text-xs mb-2">情境 A：良性循環</h5><ul className="text-xs space-y-1 text-slate-400 list-disc pl-4"><li>訊號：老闆說有新案子 -> 結果：真的讓你接手。</li><li className="mt-2 text-white">行動：點擊 <span className="text-emerald-400 font-bold">✅ REALIZED</span></li></ul></div>
                                                <div className="p-3 bg-rose-500/5 border border-rose-500/20 rounded"><h5 className="text-rose-400 font-bold text-xs mb-2">情境 B：畫餅循環</h5><ul className="text-xs space-y-1 text-slate-400 list-disc pl-4"><li>訊號：老闆說有新案子 -> 結果：無聲無息。</li><li className="mt-2 text-white">行動：點擊 <span className="text-cyan-400 font-bold">RECURRED</span></li></ul></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-950 text-center shrink-0">
                                    <button onClick={() => setShowGuide(false)} className="bg-cyan-600 hover:bg-cyan-500 text-white w-full py-3 rounded font-bold text-sm transition-colors">ACKNOWLEDGED</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {activePattern && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950 shrink-0">
                                    <h3 className="text-base font-bold text-rose-400 flex items-center gap-2"><AlertTriangle size={18} /> ANALYSIS</h3>
                                    <button onClick={() => setActivePattern(null)} className="text-slate-500 hover:text-white"><X size={24} /></button>
                                </div>
                                <div className="p-4 space-y-6 overflow-y-auto custom-scrollbar flex-1">
                                    <div className="bg-slate-900 p-4 rounded border border-slate-800">
                                        <div className="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Subject</div>
                                        <div className="text-base font-bold text-white">{activePattern.text}</div>
                                        <div className="mt-3 text-[10px] text-slate-500 border-t border-slate-800 pt-2"><span className="block mb-1">LOGS:</span>{activePattern.logs?.map((l, i) => (<div key={i} className="pl-2 border-l border-slate-700 mb-1">{l.note} <span className="opacity-50">({l.timestamp.split('T')[0]})</span></div>))}</div>
                                    </div>
                                    <button onClick={() => handleAIAnalyze(activePattern)} disabled={aiLoading} className="w-full py-3 bg-gradient-to-r from-violet-600 to-indigo-600 rounded text-xs font-bold text-white flex items-center justify-center gap-2 hover:shadow-lg transition-all">{aiLoading ? <Loader2 className="animate-spin" size={14}/> : <Sparkles size={14}/>} {aiLoading ? 'ANALYZING...' : 'AI ASSIST: IDENTIFY ROOT CAUSE'}</button>
                                    <div className="flex p-1 bg-slate-950 rounded-lg">
                                        {['tactical', 'strategic', 'quest'].map(type => (
                                            <button key={type} onClick={() => setAnalysisType(type)} className={`flex-1 py-2 text-[10px] font-bold uppercase rounded-md transition-all ${analysisType === type ? 'bg-slate-800 text-cyan-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}>{type}</button>
                                        ))}
                                    </div>
                                    <div className="space-y-4">
                                        {analysisType === 'tactical' && (<div><label className="text-xs font-bold text-emerald-500 mb-2 block">SOP / ACTION RULE</label><input type="text" value={sopInput} onChange={e => setSopInput(e.target.value)} placeholder="當 X 發生時，執行 Y..." className="w-full bg-slate-950 border border-emerald-500/30 rounded p-3 text-sm focus:border-emerald-500 outline-none"/></div>)}
                                        {analysisType === 'strategic' && (<><div><label className="text-xs font-bold text-amber-500 mb-2 block">ROOT CAUSE</label><input type="text" value={rootInput} onChange={e => setRootInput(e.target.value)} className="w-full bg-slate-950 border border-amber-500/30 rounded p-3 text-sm focus:border-amber-500 outline-none mb-3"/></div><div><label className="text-xs font-bold text-amber-500 mb-2 block">STRATEGY</label><textarea value={strategyInput} onChange={e => setStrategyInput(e.target.value)} className="w-full bg-slate-950 border border-amber-500/30 rounded p-3 text-sm focus:border-amber-500 outline-none h-24"/></div></>)}
                                        {analysisType === 'quest' && (<div className="p-4 bg-indigo-500/10 border border-indigo-500/30 rounded text-indigo-300 text-sm"><p>這將建立一個<strong>探索任務</strong>。</p></div>)}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-950 flex justify-end gap-3 shrink-0">
                                    <button onClick={() => setActivePattern(null)} className="px-4 py-2 text-slate-400 text-sm hover:text-white">Cancel</button>
                                    <button onClick={() => convertToProtocol(activePattern)} className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm tracking-wide">EXECUTE</button>
                                </div>
                            </div>
                        </div>
                    )}

                 </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
